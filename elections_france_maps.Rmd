---
title: "Elections France 2017 Maps"
output:  github_document
---

```{r}
library("sp")
library("rgdal")
library(dplyr)
library(tidyr)
library(gridExtra)

library("RColorBrewer")
library("classInt")
library('plotrix')    # Créer des échelles de couleurs

library("ggmap")
library("maptools")
```

```{r}
# Emplacement de l'archive décompressée, à remplacer par le votre
pathToShp <- "data/GEOFLA/1_DONNEES_LIVRAISON_2016-06-00236/GEOFLA_2-2_SHP_LAMB93_FR-ED161/COMMUNE/"

pathToShp_dept <- "data/GEOFLA_DEPT/1_DONNEES_LIVRAISON_2016-06-00235/GEOFLA_2-2_SHP_LAMB93_FR-ED161/DEPARTEMENT"
# Description des données via orgInfo
# Attention à ne pas mettre l'extension à la fin du nom
ogrInfo(dsn = pathToShp,layer="COMMUNE")
```

```{r}
# Import via la fonction readOGR de rgdal
# Pour info, d'autres outils existent (ex : fonction readShapeSpatial() du package maptools)
comm <- readOGR(dsn = pathToShp, layer="COMMUNE", stringsAsFactors=FALSE)
df.elections_2017<-read.csv('data/DOI/elections_2017_First_round.csv',colClasses=c(CODGEO='character'))
df.elections_2017 %>% filter(grepl('03310',INSEE_COM))
#df.elections_2017$CODGEO<-as.character(df.elections_2017$CODGEO)
```


```{r}
dim(comm@data)
comm2<-comm
comm2@data <- left_join(comm2@data, df.elections_2017, by="INSEE_COM")
str(comm2@data)
```

```{r}
# Filtrage des données pour ne garder que la région Bretagne

comm2 <- comm2[comm2@data$CODE_REG.x=="53",]
dim(comm2)
summarise_each(comm2@data, funs(sum(is.na(.)/n()))) %>% gather() %>% arrange(desc(value))
```


```{r}
# Découpage du taux de vote   en 5 classes via la méthodes des quantiles : idenfication des bornes (breaks, ou brks)
classSuffrages <- classIntervals(comm2@data$LE.PEN, 5, style = "quantile")
# Choix d'une palette de couleur pour les 5 catégories
palette <- brewer.pal(n = 5, name = "YlOrRd")


# Application de ce découpage à la variable suffrages, sauvegarde dans suffrage_cat
# On stocke, pour chaque observation, la valeur de la couleur correspondante
comm2@data$suffrage_cat <- as.character(cut(comm2@data$LE.PEN, breaks = classSuffrages$brks, labels = palette, include.lowest = TRUE))

# On stocke l'information des classes pour créer une légende 
legende_LePen <- as.character(levels(cut(comm2@data$LE.PEN, breaks = classSuffrages$brks, include.lowest = TRUE, right = FALSE)))

```



```{r}
plot(comm2, col = comm2@data$suffrage_cat, border='black',lwd=0.001)

legend("bottomleft", legend = legende_LePen, fill = palette, cex=0.6, title = "Vote Le Pen 2017")


```

  
```{r}
# Lecture des départements
departements <- readOGR(dsn=pathToShp_dept,  layer="DEPARTEMENT")

# Lecture des limites départementales pour sélectionner les frontières
frontieres <- readOGR(dsn=pathToShp_dept,  layer="LIMITE_DEPARTEMENT")
frontieres <- frontieres[frontieres$NATURE %in% c('Fronti\xe8re internationale','Limite c\xf4ti\xe8re'),]
```



```{r}



plot_map<- function(comm,feature){
  
  col <- findColours(classIntervals(
            comm@data[,feature]*100, 4, style="quantile"),
            smoothColors("white",3,"#0C3269"))

leg <- findColours(classIntervals(
            round(comm@data[,feature]*100,0), 4, style="quantile"),
            smoothColors("white",3,"#0C3269"),
            under="moins de", over="plus de", between="–",
            cutlabels=FALSE)


plot(comm,   col=col, border=col, lwd=.1)
plot(departements[departements@data$CODE_REG==53,], border="#8b8378",lwd=.7,add=TRUE)

legend("bottomleft",fill=attr(leg, "palette"),
    legend=gsub("\\.", ",", names(attr(leg,"table"))),
    title = paste(feature,":"))
  
}



myplots <- lapply(c('NoJob_all','Job_OUVRIER','Q213','MACRON','FILLON'), plot_map, comm = comm2)
n <- length(myplots)
nCol <- floor(sqrt(n))
do.call("grid.arrange", c(myplots, ncol=nCol))



```



