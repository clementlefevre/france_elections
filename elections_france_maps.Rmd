---
title: "Elections France 2017 Maps"
output:  github_document
---

```{r}
library("sp")
library("rgdal")
library(dplyr)
library(tidyr)
library(gridExtra)

library("RColorBrewer")
library("classInt")
library('plotrix')    # Créer des échelles de couleurs

library("ggmap")
library("maptools")
```

```{r}
# Emplacement de l'archive décompressée, à remplacer par le votre
pathToShp <- "data/GEOFLA/1_DONNEES_LIVRAISON_2016-06-00236/GEOFLA_2-2_SHP_LAMB93_FR-ED161/COMMUNE/"

pathToShp_dept <- "data/GEOFLA_DEPT/1_DONNEES_LIVRAISON_2016-06-00235/GEOFLA_2-2_SHP_LAMB93_FR-ED161/DEPARTEMENT"
# Description des données via orgInfo
# Attention à ne pas mettre l'extension à la fin du nom
ogrInfo(dsn = pathToShp,layer="COMMUNE")
```

```{r}
# Import via la fonction readOGR de rgdal
comm <- readOGR(dsn = pathToShp, layer="COMMUNE", stringsAsFactors=FALSE)
df.elections_2017<-read.csv('data/DOI/elections_2017_First_round.csv')
```


```{r}
dim(comm@data)
comm2<-comm
comm2@data <- left_join(comm2@data, df.elections_2017, by="INSEE_COM")
```

```{r}
# Filtrage des données pour ne garder que la région Bretagne

#comm2 <- comm2[comm2@data$CODE_REG.x=="53",]
dim(comm2)
#summarise_each(comm2@data, funs(sum(is.na(.)/n()))) %>% gather() %>% arrange(desc(value))
```
```{r}
# Lecture des départements
departements <- readOGR(dsn=pathToShp_dept,  layer="DEPARTEMENT")

# Lecture des limites départementales pour sélectionner les frontières
frontieres <- readOGR(dsn=pathToShp_dept,  layer="LIMITE_DEPARTEMENT")
frontieres <- frontieres[frontieres$NATURE %in% c('Fronti\xe8re internationale','Limite c\xf4ti\xe8re'),]
```



```{r fig.width=14, fig.height=12}



plot_map<- function(comm,feature,color_hex,title,ratio){
  
  col <- findColours(classIntervals(
            comm@data[,feature], 100, style="quantile"),
            smoothColors("white",98,color_hex))

leg <- findColours(classIntervals(
            round(comm@data[,feature]*ratio,0), 5, style="quantile"),
            smoothColors("white",3,color_hex),
            under="<", over=">", between="–",
            cutlabels=FALSE)

plot(comm,   col=col, border=col, lwd=.1,main=title)
plot(departements, border="#8b8378",lwd=.7,add=TRUE)

legend("bottomleft",fill=attr(leg, "palette"),
    legend=gsub("\\.", ",", names(attr(leg,"table"))),
    title = paste(title," :"),bty = "n",cex=1)
  
}
plot_map(comm = comm2,feature = 'LE.PEN',"#660066",'Le Pen Votes 2017 (%)',ratio=100)
plot_map(comm = comm2,feature = 'EVOLUTION_FN',"#0C3269",'Evolution of FN Votes 2012-2017 (%)',ratio=100)
plot_map(comm = comm2,feature = 'Job_OUVRIER_ratio',"#a54a4a",'% of Worker amongst working population',ratio=100)
plot_map(comm = comm2,feature = 'Q213',"#317873",'Income IQR (Euros)',ratio=1)

#myplots <- lapply(c('NoJob_all_ratio','Job_OUVRIER_ratio','Q213','MACRON','FILLON','EVOLUTION_FN'), plot_map, comm = comm2)
```
```{r}
plot(comm2,col = comm2@data$REG,  lwd=.1,main='Presidential election 2017 - First Round')
```

```{r fig.width=14, fig.height=12}
#add color for each candidate :
df<-data.frame()
candidate_colors <-  data.frame(best_candidate = levels(comm2@data$best_candidate),color='grey')
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='MACRON','#ecad31',color))
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='LE.PEN','#767374',color))
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='FILLON','#1d88be',color))
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='MÉLENCHON','#ec6a56',color))
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='HAMON','#e97ba9',color))
candidate_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='LASSALLE','#a9cfe2',color))

## add color for each region :
region_colors<- candidate_colors %>% mutate(color=ifelse(best_candidate=='LASSALLE','#a9cfe2',color))

legend_colors<-candidate_colors %>% filter(color!=1)


candidates_palette<-comm2@data %>% select(best_candidate) %>% left_join(.,candidate_colors,by='best_candidate') 
candidates_palette$color<-as.character(candidates_palette$color)

plot(comm2,col = candidates_palette$color,  lwd=.1,main='Presidential election 2017 - First Round')
par(xpd=TRUE)
legend("bottomleft", inset=c(-0.000,0),legend = unique(legend_colors$best_candidate), fill=unique(legend_colors$color),bty = "n",cex=1)


```



